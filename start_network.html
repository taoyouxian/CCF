

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Starting up a network &mdash; CCF  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="https://unpkg.com/mermaid@7.1.0/dist/mermaid.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ledger" href="ledger.html" />
    <link rel="prev" title="Getting Started" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> CCF
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Starting up a network</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#starting-up-nodes">Starting up nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-the-initial-state-of-the-network">Configuring the initial state of the network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-up-the-network">Starting up the network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-nodes-to-the-network">Adding nodes to the network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#supporting-code-updates">Supporting code updates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ledger.html">Ledger</a></li>
<li class="toctree-l1"><a class="reference internal" href="governance.html">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="kv/index.html">Key-Value store</a></li>
<li class="toctree-l1"><a class="reference internal" href="recovery.html">Catastrophic Recovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="cryptography.html">Cryptography</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html">Example App</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo.html">End-to-end demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="rpc_api.html">RPC API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CCF</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Starting up a network</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/start_network.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="starting-up-a-network">
<h1>Starting up a network<a class="headerlink" href="#starting-up-a-network" title="Permalink to this headline">¶</a></h1>
<div class="section" id="starting-up-nodes">
<h2>Starting up nodes<a class="headerlink" href="#starting-up-nodes" title="Permalink to this headline">¶</a></h2>
<p>To start up a network, operators should start up each node separately by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cchost --enclave-file<span class="o">=</span>/path/to/application --node-address<span class="o">=</span>node_ip:node_port --rpc-address<span class="o">=</span>rpc_ip:rpc_public_ip
--ledger-file<span class="o">=</span>/path/to/ledger --node-cert-file<span class="o">=</span>/path/to/node_certificate --quote-file<span class="o">=</span>/path/to/quote
<span class="m">2019</span>-08-06 <span class="m">15</span>:04:36.951158        <span class="o">[</span>info <span class="o">]</span> ../src/host/main.cpp:240             <span class="p">|</span> Starting new node
<span class="m">2019</span>-08-06 <span class="m">15</span>:04:39.355423        <span class="o">[</span>info <span class="o">]</span> ../src/host/main.cpp:257             <span class="p">|</span> Created new node
...
<span class="m">2019</span>-08-06 <span class="m">15</span>:04:40.542079        <span class="o">[</span>info <span class="o">]</span> ../src/host/enclave.h:174            <span class="p">|</span> Quote verified
...
</pre></div>
</div>
<p>When starting up, each node generates its own key pair and outputs the certificate associated with the public key at the location specified by <code class="docutils literal notranslate"><span class="pre">--node-cert</span></code>. A quote file, required for remote attestation when this node joins the network, is also output at the location specified by <code class="docutils literal notranslate"><span class="pre">--quote-file</span></code>.</p>
</div>
<div class="section" id="configuring-the-initial-state-of-the-network">
<h2>Configuring the initial state of the network<a class="headerlink" href="#configuring-the-initial-state-of-the-network" title="Permalink to this headline">¶</a></h2>
<p>Once the initial set of nodes is running, the <code class="docutils literal notranslate"><span class="pre">nodes.json</span></code> file specifying the configuration of the original network should be created. For example, for a network of two nodes, the <code class="docutils literal notranslate"><span class="pre">nodes.json</span></code> file will be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cat nodes.json
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&quot;pubhost&quot;</span>: <span class="s2">&quot;rpc_public_ip0&quot;</span>,
        <span class="s2">&quot;cert&quot;</span>: <span class="o">[</span>&lt;output node0 cert bytes&gt;<span class="o">]</span>,
        <span class="s2">&quot;host&quot;</span>: <span class="s2">&quot;node/rpc_ip0&quot;</span>,
        <span class="s2">&quot;quote&quot;</span>: <span class="o">[</span>&lt;output quote0 bytes&gt;<span class="o">]</span>,
        <span class="s2">&quot;status&quot;</span>: <span class="m">0</span>,
        <span class="s2">&quot;nodeport&quot;</span>: <span class="s2">&quot;node_port0&quot;</span>,
        <span class="s2">&quot;rpcport&quot;</span>: <span class="s2">&quot;rpc_port0&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
        <span class="s2">&quot;pubhost&quot;</span>: <span class="s2">&quot;rpc_public_ip1&quot;</span>,
        <span class="s2">&quot;cert&quot;</span>: <span class="o">[</span>&lt;output node1 cert bytes&gt;<span class="o">]</span>,
        <span class="s2">&quot;host&quot;</span>: <span class="s2">&quot;node/rpc_ip1&quot;</span>,
        <span class="s2">&quot;quote&quot;</span>: <span class="o">[</span>&lt;output quote1 bytes&gt;<span class="o">]</span>,
        <span class="s2">&quot;status&quot;</span>: <span class="m">0</span>,
        <span class="s2">&quot;nodeport&quot;</span>: <span class="s2">&quot;node_port1&quot;</span>,
        <span class="s2">&quot;rpcport&quot;</span>: <span class="s2">&quot;rpc_port1&quot;</span>
    <span class="o">}</span>
<span class="o">]</span>
</pre></div>
</div>
<p>Then, certificates for members and users can be created to allow secure TLS communication between the clients and the enclaves of each node. For example, for two members and one user, you should run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ genesisgenerator cert --name<span class="o">=</span>member1
$ genesisgenerator cert --name<span class="o">=</span>member2
$ genesisgenerator cert --name<span class="o">=</span>user1
</pre></div>
</div>
<p>Finally, the genesis transaction (<code class="docutils literal notranslate"><span class="pre">tx0</span></code>), containing the initial state of the network, including the initial set of nodes, users and members certificates and governance scripts, can be created:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ genesisgenerator tx --members<span class="o">=</span>member*cert.pem --users<span class="o">=</span>user*cert.pem --nodes<span class="o">=</span>nodes.json --gov-script<span class="o">=</span>src/runtime_config/gov.lua --tx0<span class="o">=</span>tx0 --start-json<span class="o">=</span>startNetwork.json
</pre></div>
</div>
<p>This command also generates the <code class="docutils literal notranslate"><span class="pre">startNetwork.json</span></code> RPC file required to start up the network.</p>
</div>
<div class="section" id="starting-up-the-network">
<h2>Starting up the network<a class="headerlink" href="#starting-up-the-network" title="Permalink to this headline">¶</a></h2>
<p>Once the initial nodes are running and the initial state of the network is ready to deploy, the network can be started by one of the members:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ client --server-address<span class="o">=</span>node0_ip:node0_rpcport startnetwork --ca<span class="o">=</span>node0_cert_file --req<span class="o">=</span>@startNetwork.json
</pre></div>
</div>
<p>When executing the <code class="docutils literal notranslate"><span class="pre">startNetwork.json</span></code> RPC request, the target node deserialises the genesis transaction and immediately becomes the Raft leader of the new single-node network. Business transactions can then be issued by users and will commit immediately.</p>
</div>
<div class="section" id="adding-nodes-to-the-network">
<h2>Adding nodes to the network<a class="headerlink" href="#adding-nodes-to-the-network" title="Permalink to this headline">¶</a></h2>
<p>Once a network has been started on one node, assuming that this node remains leader of the Raft network, join network RPC files can be generated for all others nodes defined in the initial state of the network (<code class="docutils literal notranslate"><span class="pre">nodes.json</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ genesisgenerator joinrpc --network-cert<span class="o">=</span>networkcert.pem --target-address<span class="o">=</span>node0_ip:node0_rpcport --join-json<span class="o">=</span>joinNetwork.json
</pre></div>
</div>
<p>Once done, each additional node (here, node 1) can join the existing network by running the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ client --server-address<span class="o">=</span>node1_ip:node1_rpcport --ca<span class="o">=</span>node1_cert_file joinnetwork --req<span class="o">=</span>@joinNetwork.json
</pre></div>
</div>
<p>When executing the <code class="docutils literal notranslate"><span class="pre">joinNetwork.json</span></code> RPC, the target node initiates an enclave-to-enclave TLS connection to the network leader to retrieve the network secrets required to decrypt the serialised replicated transactions. Once the join protocol completes, the new node becomes a follower of the Raft network and starts replicating transactions executed by the leader.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When starting up the network or when a node joins an existing network, the network secrets required to decrypt the ledger are sealed to disc so that the network can later be recovered. See <a class="reference internal" href="recovery.html#catastrophic-recovery"><span class="std std-ref">Catastrophic Recovery</span></a> for more details on how to recover a crashed network.</p>
</div>

            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <script>mermaid.initialize({startOnLoad:true});</script><div class="mermaid">
            sequenceDiagram
    participant Members
    participant Users
    participant Leader
    participant Follower

    Members-&gt;&gt;+Leader: start network
    Leader-&gt;&gt;+Leader: New network secrets
    Leader--&gt;&gt;Members: start network success

    Note over Leader: Part of Private Network

    Members-&gt;&gt;+Follower: join network
    Follower-&gt;&gt;+Leader: join network (over TLS)
    Leader-&gt;&gt;+Follower: Network Secrets (over TLS)

    Note over Follower: Part of Private Network

    Follower--&gt;&gt;Members: join network response

    loop Business transactions
        Users-&gt;&gt;+Leader: Tx
        Leader--&gt;&gt;Users: response
        Leader-&gt;&gt;+Follower: Serialised Tx
    end
        </div></div>
<div class="section" id="supporting-code-updates">
<h2>Supporting code updates<a class="headerlink" href="#supporting-code-updates" title="Permalink to this headline">¶</a></h2>
<p>The code being executed by the nodes might need to be updated from time to time.
This can be achieved by creating a “new_code” proposal and passing the hash of the signed code. Once the proposal has been accepted, nodes running the new code may join the network. This allows stopping nodes running older versions of the code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is important to keep the code compatible with the previous version, since there will be a point in time in which the new code is running on at least one node, while the other version is running on a different node.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The safest way to restart or replace nodes is by stopping a single node running the old version and starting a node running the new version as a sequence of operations, in order to avoid a situation in which most nodes have been stopped, and new nodes will not be able to join since it would be impossible to reach a majority of nodes agreeing to accept new nodes (this restriction is imposed by the consensus algorithm).</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ledger.html" class="btn btn-neutral float-right" title="Ledger" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Microsoft Research

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>